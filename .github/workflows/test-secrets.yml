# Test Secrets Configuration
#
# This workflow validates that all required GitHub Secrets are properly configured
# for OIDC authentication with AWS. It's designed to be run manually to test
# secrets before attempting actual deployments.
#
# Educational Note:
# - This is a "smoke test" for your CI/CD configuration
# - Run this AFTER setting up OIDC in AWS and adding secrets to GitHub
# - Green checkmark = secrets are configured correctly
# - Red X = something is missing or misconfigured

name: Test Secrets Configuration

# Only allow manual triggering from GitHub Actions UI
# This prevents accidental runs and keeps CI clean
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (dev or prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

# Required for OIDC authentication
permissions:
  id-token: write  # Allows workflow to request AWS credentials
  contents: read   # Allows workflow to read repository

jobs:
  test-oidc-dev:
    name: Test Dev Environment OIDC
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'dev'

    steps:
      # ============================================
      # 1. VERIFY SECRETS EXIST
      # ============================================
      - name: Check required secrets are set
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ROLE_ARN_DEV: ${{ secrets.AWS_ROLE_ARN_DEV }}
          STRIPE_SECRET_KEY_DEV: ${{ secrets.STRIPE_SECRET_KEY_DEV }}
        run: |
          echo "Checking required secrets..."

          # Check AWS_ACCOUNT_ID
          if [ -z "${AWS_ACCOUNT_ID}" ]; then
            echo "âŒ AWS_ACCOUNT_ID is not set"
            exit 1
          else
            echo "âœ… AWS_ACCOUNT_ID is set (${#AWS_ACCOUNT_ID} characters)"
          fi

          # Check AWS_REGION
          if [ -z "${AWS_REGION}" ]; then
            echo "âŒ AWS_REGION is not set"
            exit 1
          else
            echo "âœ… AWS_REGION is set: ${AWS_REGION}"
          fi

          # Check AWS_ROLE_ARN_DEV
          if [ -z "${AWS_ROLE_ARN_DEV}" ]; then
            echo "âŒ AWS_ROLE_ARN_DEV is not set"
            exit 1
          else
            echo "âœ… AWS_ROLE_ARN_DEV is set"
            echo "   Role: ${AWS_ROLE_ARN_DEV}"
          fi

          # Check STRIPE_SECRET_KEY_DEV
          if [ -z "${STRIPE_SECRET_KEY_DEV}" ]; then
            echo "âš ï¸  STRIPE_SECRET_KEY_DEV is not set (optional for now)"
          else
            echo "âœ… STRIPE_SECRET_KEY_DEV is set (${#STRIPE_SECRET_KEY_DEV} characters)"
          fi

      # ============================================
      # 2. TEST OIDC AUTHENTICATION
      # ============================================
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ secrets.AWS_REGION }}
        # Educational: If this step fails, common causes:
        # 1. IAM role doesn't exist in AWS
        # 2. IAM role trust policy doesn't allow this GitHub repo
        # 3. OIDC Identity Provider not created in AWS
        # 4. Wrong role ARN in GitHub Secrets

      - name: Verify AWS credentials
        env:
          EXPECTED_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          echo "==================== AWS CREDENTIALS TEST ===================="
          echo ""
          echo "If you see this message, OIDC authentication succeeded! ðŸŽ‰"
          echo ""
          echo "Authenticated AWS Identity:"
          aws sts get-caller-identity
          echo ""
          echo "Expected Account ID: ${EXPECTED_ACCOUNT_ID}"

          ACTUAL_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)

          if [ "${ACTUAL_ACCOUNT}" = "${EXPECTED_ACCOUNT_ID}" ]; then
            echo "âœ… Account ID matches expected value"
          else
            echo "âŒ Account ID mismatch!"
            echo "   Expected: ${EXPECTED_ACCOUNT_ID}"
            echo "   Actual: ${ACTUAL_ACCOUNT}"
            exit 1
          fi

          echo ""
          echo "Assumed Role ARN:"
          aws sts get-caller-identity --query Arn --output text
          echo ""
          echo "==============================================================="

      # ============================================
      # 3. TEST CDK BASIC FUNCTIONALITY
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Test CDK list stacks
        working-directory: infra
        run: |
          echo "Testing CDK with authenticated credentials..."
          pnpm cdk list --context stage=dev
          echo "âœ… CDK can authenticate and list stacks"

      # ============================================
      # 4. SUMMARY
      # ============================================
      - name: Success summary
        if: success()
        env:
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "## âœ… All Tests Passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Dev" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Account:** ${ACCOUNT_ID}" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Region:** ${REGION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What This Means" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All required secrets are configured" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OIDC authentication with AWS works" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CDK can access AWS and list stacks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ready for actual deployments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test production secrets (run this workflow again, select 'prod')" >> $GITHUB_STEP_SUMMARY
          echo "2. Merge a PR to main to trigger dev deployment" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify dev deployment succeeds" >> $GITHUB_STEP_SUMMARY

  test-oidc-prod:
    name: Test Prod Environment OIDC
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'prod'

    steps:
      # ============================================
      # 1. VERIFY SECRETS EXIST
      # ============================================
      - name: Check required secrets are set
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ROLE_ARN_PROD: ${{ secrets.AWS_ROLE_ARN_PROD }}
        run: |
          echo "Checking required secrets for production..."

          # Check AWS_ACCOUNT_ID
          if [ -z "${AWS_ACCOUNT_ID}" ]; then
            echo "âŒ AWS_ACCOUNT_ID is not set"
            exit 1
          else
            echo "âœ… AWS_ACCOUNT_ID is set (${#AWS_ACCOUNT_ID} characters)"
          fi

          # Check AWS_REGION
          if [ -z "${AWS_REGION}" ]; then
            echo "âŒ AWS_REGION is not set"
            exit 1
          else
            echo "âœ… AWS_REGION is set: ${AWS_REGION}"
          fi

          # Check AWS_ROLE_ARN_PROD
          if [ -z "${AWS_ROLE_ARN_PROD}" ]; then
            echo "âŒ AWS_ROLE_ARN_PROD is not set"
            exit 1
          else
            echo "âœ… AWS_ROLE_ARN_PROD is set"
            echo "   Role: ${AWS_ROLE_ARN_PROD}"
          fi

      # ============================================
      # 2. TEST OIDC AUTHENTICATION
      # ============================================
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS credentials
        env:
          EXPECTED_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          echo "==================== AWS CREDENTIALS TEST ===================="
          echo ""
          echo "If you see this message, OIDC authentication succeeded! ðŸŽ‰"
          echo ""
          echo "Authenticated AWS Identity:"
          aws sts get-caller-identity
          echo ""
          echo "Expected Account ID: ${EXPECTED_ACCOUNT_ID}"

          ACTUAL_ACCOUNT=$(aws sts get-caller-identity --query Account --output text)

          if [ "${ACTUAL_ACCOUNT}" = "${EXPECTED_ACCOUNT_ID}" ]; then
            echo "âœ… Account ID matches expected value"
          else
            echo "âŒ Account ID mismatch!"
            echo "   Expected: ${EXPECTED_ACCOUNT_ID}"
            echo "   Actual: ${ACTUAL_ACCOUNT}"
            exit 1
          fi

          echo ""
          echo "Assumed Role ARN:"
          aws sts get-caller-identity --query Arn --output text
          echo ""
          echo "==============================================================="

      # ============================================
      # 3. TEST CDK BASIC FUNCTIONALITY
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Test CDK list stacks
        working-directory: infra
        run: |
          echo "Testing CDK with authenticated credentials..."
          pnpm cdk list --context stage=prod
          echo "âœ… CDK can authenticate and list stacks"

      # ============================================
      # 4. SUMMARY
      # ============================================
      - name: Success summary
        if: success()
        env:
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "## âœ… Production Secrets Configured! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Account:** ${ACCOUNT_ID}" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Region:** ${REGION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What This Means" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production secrets are configured" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OIDC authentication with AWS works" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CDK can access AWS and list stacks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ready for production deployments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Production Deployment Reminder" >> $GITHUB_STEP_SUMMARY
          echo "Production deployments require manual approval." >> $GITHUB_STEP_SUMMARY
          echo "Always review CDK diff carefully before approving." >> $GITHUB_STEP_SUMMARY
